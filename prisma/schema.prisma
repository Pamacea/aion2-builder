// ================================================================
// Prisma Schema - MMORPG Build System
// ================================================================
// Ce schéma définit les modèles de base pour les Classes, Sorts,
// Passifs, Stigmas, ainsi que le système de Build pour les joueurs.
// Documentation Prisma : https://pris.ly/d/prisma-schema
// ================================================================

// ---------------------------
// GENERATOR
// ---------------------------
generator client {
  provider               = "prisma-client"
  output                 = "../src/generated/prisma"
  moduleFormat           = "esm"
  generatedFileExtension = "ts"
  importFileExtension    = "ts"
}

// ---------------------------
// DATASOURCE
// ---------------------------
datasource db {
  provider = "postgresql"
}

// ================================================================
// 0. Users and Accounts
// ================================================================

model User {
  id            String   @id @default(cuid())
  name          String?
  email         String?  @unique
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  sessions      Session[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ================================================================
// I. Modèles de Base (Classes, Tags, Abilities, Passives, Stigmas)
// ================================================================

// ---------------------------
// 1. Classes
// ---------------------------
model Class {
  id   Int    @id @default(autoincrement())
  name String @unique

  iconUrl      String?
  bannerUrl    String?
  characterUrl String?

  description String?

  // Relations
  tags      Tag[] // Catégories attribuées à la classe
  abilities Ability[] // Sorts de base (12 par classe)
  passives  Passive[] // Passifs de base (10 par classe)
  stigmas   Stigma[] // Stigmas spécifiques ou communs
  builds    Build[] // Builds créés pour cette classe
}

// ---------------------------
// 2. Tags (Catégories de Classes)
// ---------------------------
model Tag {
  id   Int    @id @default(autoincrement())
  name String @unique

  // Relation plusieurs-à-plusieurs avec les classes
  classes Class[]
}

// ---------------------------
// 3. Sorts (Abilities)
// ---------------------------

model SpellTag {
  id   Int    @id @default(autoincrement())
  name String @unique

  abilities Ability[]
  passives Passive[]
  stigmas Stigma[]
}

model Ability {
  id          Int     @id @default(autoincrement())
  name        String
  iconUrl     String?
  description String?
  baseCost Int @default(1)
  baseCostModifier Int @default(2)

  maxLevel Int @default(10)

  // Stats et Coûts
  damageMin         Int?
  damageMinModifier Int? // Modifier fixe (utilisé si damageMinModifiers est null)
  damageMinModifiers Json? // Tableau de modifiers par niveau [modifierNiveau2, modifierNiveau3, ...]

  damageMax         Int?
  damageMaxModifier Int? // Modifier fixe (utilisé si damageMaxModifiers est null)
  damageMaxModifiers Json? // Tableau de modifiers par niveau [modifierNiveau2, modifierNiveau3, ...]

  damageBoost       Int?
  damageBoostModifier Int?
  damageBoostModifiers Json? // Tableau de modifiers par niveau

  damageTolerance   Int?
  damageToleranceModifier Int?
  damageToleranceModifiers Json? // Tableau de modifiers par niveau

  healMin      Int?
  healMinModifier Int?
  healMinModifiers Json? // Tableau de modifiers par niveau

  healMax      Int?
  healMaxModifier Int?
  healMaxModifiers Json? // Tableau de modifiers par niveau

  healBoost    Int?
  healBoostModifier Int?
  healBoostModifiers Int? // Tableau de modifiers par niveau

  incomingHeal Int?
  incomingHealModifier Int?
  incomingHealModifiers Int? // Tableau de modifiers par niveau
  
  minMP        Int?
  minMPModifier Int?
  minMPModifiers Json? // Tableau de modifiers par niveau

  maxHP        Int?
  maxHPModifier Int?
  maxHPModifiers Json? // Tableau de modifiers par niveau

  minHP        Int?
  minHPModifier Int?
  minHPModifiers Json? // Tableau de modifiers par niveau
  maxMP        Int?
  maxMPModifier Int?
  maxMPModifiers Json? // Tableau de modifiers par niveau

  criticalHitResist  Int?
  criticalHitResistModifier Int?
  statusEffectResist Int?
  statusEffectResistModifier Int?
  impactTypeResist   Int?
  impactTypeResistModifier Int?

  attack  Int?
  attackModifier Int?
  defense Int?
  defenseModifier Int?

  blockDamage Int?
  blockDamageModifier Int?
  blockDamageModifiers Json? // Tableau de modifiers par niveau

  damagePerSecond Int?
  damagePerSecondModifier Int?
  damagePerSecondModifiers Json? // Tableau de modifiers par niveau

  staggerDamage Int?

  manaCost  Int?
  manaRegen Int?

  range Int? @default(20)
  area  Int? @default(4)

  castingDuration String? @default("Instant Cast")
  cooldown        String? @default("Instant Cast")

  target String? @default("Single Target")

  // Conditions du sort (ex: ["Nontarget Skill", "Mobile"])
  condition String[] @default([])

  // Conditions d'effet
  effectCondition String? 
  chargeLevels String?

  // Relation vers les tags  du sort
  spellTag SpellTag[]

  // Relation vers la classe
  classId Int
  class   Class @relation(fields: [classId], references: [id])

  // Relations avec le système de spécialités et les builds
  specialtyChoices SpecialtyChoice[]
  buildAbilities   BuildAbility[]
  
  // Chain Skills (compétences enchaînées)
  chainSkills      ChainSkill[] @relation("AbilityChainSkills")
  parentAbilities   ChainSkill[] @relation("AbilityParentSkills")
}

// ---------------------------
// 4. Chain Skills (Compétences enchaînées pour Abilities)
// ---------------------------
model ChainSkill {
  id            Int     @id @default(autoincrement())
  parentAbilityId Int   // Ability parente
  chainAbilityId   Int   // Ability chain skill
  
  // Conditions spécifiques pour cette relation chain skill (ex: ["Nontarget Skill", "Mobile"])
  condition String[] @default([])
  
  parentAbility Ability @relation("AbilityParentSkills", fields: [parentAbilityId], references: [id], onDelete: Cascade)
  chainAbility  Ability @relation("AbilityChainSkills", fields: [chainAbilityId], references: [id], onDelete: Cascade)
  
  @@unique([parentAbilityId, chainAbilityId])
  @@index([parentAbilityId])
}

// ---------------------------
// 5. Chain Skills (Compétences enchaînées pour Stigmas)
// ---------------------------
model ChainSkillStigma {
  id            Int     @id @default(autoincrement())
  parentStigmaId Int   // Stigma parent
  chainStigmaId   Int   // Stigma chain skill
  
  // Conditions spécifiques pour cette relation chain skill (ex: ["Nontarget Skill", "Mobile"])
  condition String[] @default([])
  
  parentStigma Stigma @relation("StigmaParentSkills", fields: [parentStigmaId], references: [id], onDelete: Cascade)
  chainStigma  Stigma @relation("StigmaChainSkills", fields: [chainStigmaId], references: [id], onDelete: Cascade)
  
  @@unique([parentStigmaId, chainStigmaId])
  @@index([parentStigmaId])
}

// ---------------------------
// 6. Choix de Spécialité (SpecialtyChoice)
// ---------------------------
model SpecialtyChoice {
  id          Int    @id @default(autoincrement())
  description String
  unlockLevel Int // Niveau requis pour débloquer (ex: 8, 12, 16)

  // Relation vers le sort correspondant (optionnel - soit ability soit stigma)
  abilityId Int?
  ability   Ability? @relation(fields: [abilityId], references: [id])

  // Relation vers le stigma correspondant (optionnel - soit ability soit stigma)
  stigmaId Int?
  stigma   Stigma? @relation(fields: [stigmaId], references: [id])
}

// ---------------------------
// 5. Passifs (Passive)
// ---------------------------
model Passive {
  id          Int     @id @default(autoincrement())
  name        String
  iconUrl     String?
  description String?
  baseCost Int @default(1)
  baseCostModifier Int @default(2)

  maxLevel Int @default(10)

  // Stats et Coûts
  damageMin         Int?
  damageMinModifier Int? // Modifier fixe (utilisé si damageMinModifiers est null)
  damageMinModifiers Json? // Tableau de modifiers par niveau [modifierNiveau2, modifierNiveau3, ...]

  damageMax         Int?
  damageMaxModifier Int? // Modifier fixe (utilisé si damageMaxModifiers est null)
  damageMaxModifiers Json? // Tableau de modifiers par niveau [modifierNiveau2, modifierNiveau3, ...]

  damageBoost       Int?
  damageBoostModifier Int?
  damageBoostModifiers Json? // Tableau de modifiers par niveau

  damageTolerance   Int?
  damageToleranceModifier Int?
  damageToleranceModifiers Json? // Tableau de modifiers par niveau

  healMin      Int?
  healMinModifier Int?
  healMinModifiers Json? // Tableau de modifiers par niveau

  healMax      Int?
  healMaxModifier Int?
  healMaxModifiers Json? // Tableau de modifiers par niveau

  healBoost    Int?
  healBoostModifier Int?
  healBoostModifiers Int? // Tableau de modifiers par niveau

  incomingHeal Int?
  incomingHealModifier Int?
  incomingHealModifiers Int? // Tableau de modifiers par niveau
  
  minMP        Int?
  minMPModifier Int?
  minMPModifiers Json? // Tableau de modifiers par niveau

  maxHP        Int?
  maxHPModifier Int?
  maxHPModifiers Json? // Tableau de modifiers par niveau

  minHP        Int?
  minHPModifier Int?
  minHPModifiers Json? // Tableau de modifiers par niveau
  maxMP        Int?
  maxMPModifier Int?
  maxMPModifiers Json? // Tableau de modifiers par niveau

  criticalHitResist  Int?
  criticalHitResistModifier Int?
  statusEffectResist Int?
  statusEffectResistModifier Int?
  impactTypeResist   Int?
  impactTypeResistModifier Int?

  attack  Int?
  attackModifier Int?
  defense Int?
  defenseModifier Int?

  blockDamage Int?
  blockDamageModifier Int?
  blockDamageModifiers Json? // Tableau de modifiers par niveau

  damagePerSecond Int?
  damagePerSecondModifier Int?
  damagePerSecondModifiers Json? // Tableau de modifiers par niveau

  staggerDamage Int?

  manaCost  Int?
  manaRegen Int?

  range Int? @default(20)
  area  Int? @default(4)

  castingDuration String? @default("Instant Cast")
  cooldown        String? @default("Instant Cast")

  target String? @default("Single Target")

  // Conditions d'effet
  effectCondition String? 
  chargeLevels String?

  // Relation vers les tags  du sort
  spellTag SpellTag[]

  // Relation vers la classe
  classId Int
  class   Class @relation(fields: [classId], references: [id])

  // Relation vers les builds
  buildPassives BuildPassive[]
}

// ---------------------------
// 6. Stigmas
// ---------------------------
model Stigma {
  id          Int     @id @default(autoincrement())
  name        String
  iconUrl     String?
  maxLevel    Int     @default(20)
  description String?

  // Conditions d'effet
  effectCondition String? 
  chargeLevels String

  // Stats et Coûts
  damageMin         Int?
  damageMinModifier Int? // Modifier fixe (utilisé si damageMinModifiers est null)
  damageMinModifiers Json? // Tableau de modifiers par niveau [modifierNiveau2, modifierNiveau3, ...]

  damageMax         Int?
  damageMaxModifier Int? // Modifier fixe (utilisé si damageMaxModifiers est null)
  damageMaxModifiers Json? // Tableau de modifiers par niveau [modifierNiveau2, modifierNiveau3, ...]

  damageBoost       Int?
  damageBoostModifier Int?
  damageBoostModifiers Json? // Tableau de modifiers par niveau

  damageTolerance   Int?
  damageToleranceModifier Int?
  damageToleranceModifiers Json? // Tableau de modifiers par niveau

  healMin      Int?
  healMinModifier Int?
  healMinModifiers Json? // Tableau de modifiers par niveau

  healMax      Int?
  healMaxModifier Int?
  healMaxModifiers Json? // Tableau de modifiers par niveau

  healBoost    Int?
  healBoostModifier Int?
  healBoostModifiers Int? // Tableau de modifiers par niveau

  incomingHeal Int?
  incomingHealModifier Int?
  incomingHealModifiers Int? // Tableau de modifiers par niveau
  
  minMP        Int?
  minMPModifier Int?
  minMPModifiers Json? // Tableau de modifiers par niveau

  maxHP        Int?
  maxHPModifier Int?
  maxHPModifiers Json? // Tableau de modifiers par niveau

  minHP        Int?
  minHPModifier Int?
  minHPModifiers Json? // Tableau de modifiers par niveau
  maxMP        Int?
  maxMPModifier Int?
  maxMPModifiers Json? // Tableau de modifiers par niveau

  criticalHitResist  Int?
  criticalHitResistModifier Int?
  statusEffectResist Int?
  statusEffectResistModifier Int?
  impactTypeResist   Int?
  impactTypeResistModifier Int?

  attack  Int?
  attackModifier Int?
  defense Int?
  defenseModifier Int?

  blockDamage Int?
  blockDamageModifier Int?
  blockDamageModifiers Json? // Tableau de modifiers par niveau

  damagePerSecond Int?
  damagePerSecondModifier Int?
  damagePerSecondModifiers Json? // Tableau de modifiers par niveau

  staggerDamage Int?

  manaCost  Int?
  manaRegen Int?

  range Int? @default(20)
  area  Int? @default(4)

  castingDuration String? @default("Instant Cast")
  cooldown        String? @default("Instant Cast")

  target String? @default("Single Target")

  // Conditions du stigma (ex: ["Nontarget Skill", "Mobile"])
  condition String[] @default([])

  baseCost Int     @default(1) // Coût par défaut en Stigma Points (STP)
  baseCostModifier Int @default(2)

  // Relations
  spellTag SpellTag[]
  classes      Class[] // Classes pouvant équiper ce stigma
  buildStigmas BuildStigma[] // Relation vers les builds
  specialtyChoices SpecialtyChoice[] // Choix de spécialité pour ce stigma
  
  // Chain Skills (compétences enchaînées)
  chainSkills      ChainSkillStigma[] @relation("StigmaChainSkills")
  parentStigmas    ChainSkillStigma[] @relation("StigmaParentSkills")
}

// ================================================================
// II. Modèles du Builder (Build, BuildAbility, BuildPassive, BuildStigma)
// ================================================================

// ---------------------------
// 7. Builds (Configuration de Classe)
// ---------------------------
model Build {
  id   Int    @id @default(autoincrement())
  name String

  // Classe associée
  classId Int
  class   Class @relation(fields: [classId], references: [id])

  // Points de compétence
  baseSP  Int @default(231) // Points de base après leveling
  extraSP Int @default(0) // Points supplémentaires (Wisdom Stone)

  // Points de stigma
  baseSTP  Int @default(40) // Points de base
  extraSTP Int @default(0) // Points supplémentaires farmables

  // Shortcuts (barre de raccourcis) - JSON: { slotId: { type, abilityId/stigmaId, buildAbilityId/buildStigmaId } }
  shortcuts Json?

  // Relations détaillées
  abilities BuildAbility[]
  passives  BuildPassive[]
  stigmas   BuildStigma[]
}

// ---------------------------
// 8. BuildAbility (Niveau et spécialités actives)
// ---------------------------
model BuildAbility {
  id        Int     @id @default(autoincrement())
  buildId   Int
  build     Build   @relation(fields: [buildId], references: [id])
  abilityId Int
  ability   Ability @relation(fields: [abilityId], references: [id])

  // Niveau choisi par l'utilisateur
  level    Int @default(1)
  maxLevel Int @default(20)

  // Spécialités actives (référencent SpecialtyChoice.id)
  activeSpecialtyChoiceIds Int[]
  
  // Chain Skills sélectionnés (IDs des chain skills choisis, max 2)
  selectedChainSkillIds Int[] @default([])
}

// ---------------------------
// 9. BuildPassive (Niveau du passif)
// ---------------------------
model BuildPassive {
  id        Int     @id @default(autoincrement())
  buildId   Int
  build     Build   @relation(fields: [buildId], references: [id])
  passiveId Int
  passive   Passive @relation(fields: [passiveId], references: [id])

  // Niveau choisi par l'utilisateur
  level    Int @default(1)
  maxLevel Int @default(20)
}

// ---------------------------
// 10. BuildStigma (Stigmas équipés)
// ---------------------------
model BuildStigma {
  id       Int    @id @default(autoincrement())
  buildId  Int
  build    Build  @relation(fields: [buildId], references: [id])
  stigmaId Int
  stigma   Stigma @relation(fields: [stigmaId], references: [id])

  level    Int @default(1)
  maxLevel Int @default(20)

  // Coût du stigma pour ce build (peut différer du baseCost)
  stigmaCost Int @default(10)

  // Spécialités actives (référencent SpecialtyChoice.id)
  activeSpecialtyChoiceIds Int[]
  
  // Chain Skills sélectionnés (IDs des chain skills choisis, max 2)
  selectedChainSkillIds Int[] @default([])
}
