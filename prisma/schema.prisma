// ================================================================
// Prisma Schema - MMORPG Build System
// ================================================================
// Ce schéma définit les modèles de base pour les Classes, Sorts,
// Passifs, Stigmas, ainsi que le système de Build pour les joueurs.
// Documentation Prisma : https://pris.ly/d/prisma-schema
// ================================================================

// ---------------------------
// GENERATOR
// ---------------------------
generator client {
  provider               = "prisma-client"
  output                 = "../src/generated/prisma"
  moduleFormat           = "esm"
  generatedFileExtension = "ts"
  importFileExtension    = "ts"
}

// ---------------------------
// DATASOURCE
// ---------------------------
datasource db {
  provider = "postgresql"
}

// ================================================================
// I. Modèles de Base (Classes, Tags, Abilities, Passives, Stigmas)
// ================================================================

// ---------------------------
// 1. Classes
// ---------------------------
model Class {
  id   Int    @id @default(autoincrement())
  name String @unique

  iconUrl      String?
  bannerUrl    String?
  characterUrl String?

  description String?

  // Relations
  tags      Tag[] // Catégories attribuées à la classe
  abilities Ability[] // Sorts de base (12 par classe)
  passives  Passive[] // Passifs de base (10 par classe)
  stigmas   Stigma[] // Stigmas spécifiques ou communs
  builds    Build[] // Builds créés pour cette classe
}

// ---------------------------
// 2. Tags (Catégories de Classes)
// ---------------------------
model Tag {
  id   Int    @id @default(autoincrement())
  name String @unique

  // Relation plusieurs-à-plusieurs avec les classes
  classes Class[]
}

// ---------------------------
// 3. Sorts (Abilities)
// ---------------------------
model Ability {
  id          Int     @id @default(autoincrement())
  name        String
  iconUrl     String?
  description String?

  // Stats et Coûts
  damageMin       Int?
  damageMax       Int?
  targetRange     Int?
  effect          String?
  type            String? @default("Physical")
  category        String? @default("Attack")
  isNontarget     Boolean @default(false)
  isMobile        Boolean @default(false)
  castingDuration String? @default("Instant Cast")
  cooldown        String? @default("Instant Cast")
  maxLevel        Int     @default(20)

  // Relation vers la classe
  classId Int
  class   Class @relation(fields: [classId], references: [id])

  // Relations avec le système de spécialités et les builds
  specialtyChoices SpecialtyChoice[]
  buildAbilities   BuildAbility[]
}

// ---------------------------
// 4. Choix de Spécialité (SpecialtyChoice)
// ---------------------------
model SpecialtyChoice {
  id          Int    @id @default(autoincrement())
  description String
  unlockLevel Int // Niveau requis pour débloquer (ex: 8, 12, 16)

  // Relation vers le sort correspondant
  abilityId Int
  ability   Ability @relation(fields: [abilityId], references: [id])
}

// ---------------------------
// 5. Passifs (Passive)
// ---------------------------
model Passive {
  id          Int     @id @default(autoincrement())
  name        String
  iconUrl     String?
  description String?
  maxLevel    Int     @default(20)

  // Relation vers la classe
  classId Int
  class   Class @relation(fields: [classId], references: [id])

  // Relation vers les builds
  buildPassives BuildPassive[]
}

// ---------------------------
// 6. Stigmas
// ---------------------------
model Stigma {
  id          Int     @id @default(autoincrement())
  name        String
  iconUrl     String?
  maxLevel    Int     @default(20)
  description String?

  isShared Boolean @default(false) // Partagé entre plusieurs classes
  baseCost Int     @default(10) // Coût par défaut en Stigma Points (STP)

  // Relations
  classes      Class[] // Classes pouvant équiper ce stigma
  buildStigmas BuildStigma[] // Relation vers les builds
}

// ================================================================
// II. Modèles du Builder (Build, BuildAbility, BuildPassive, BuildStigma)
// ================================================================

// ---------------------------
// 7. Builds (Configuration de Classe)
// ---------------------------
model Build {
  id   Int    @id @default(autoincrement())
  name String

  // Classe associée
  classId Int
  class   Class @relation(fields: [classId], references: [id])

  // Points de compétence
  baseSP  Int @default(231) // Points de base après leveling
  extraSP Int @default(0) // Points supplémentaires (Wisdom Stone)

  // Points de stigma
  baseSTP  Int @default(40) // Points de base
  extraSTP Int @default(0) // Points supplémentaires farmables

  // Relations détaillées
  abilities BuildAbility[]
  passives  BuildPassive[]
  stigmas   BuildStigma[]
}

// ---------------------------
// 8. BuildAbility (Niveau et spécialités actives)
// ---------------------------
model BuildAbility {
  id        Int     @id @default(autoincrement())
  buildId   Int
  build     Build   @relation(fields: [buildId], references: [id])
  abilityId Int
  ability   Ability @relation(fields: [abilityId], references: [id])

  // Niveau choisi par l'utilisateur
  level    Int @default(1)
  maxLevel Int @default(20)

  // Spécialités actives (référencent SpecialtyChoice.id)
  activeSpecialtyChoiceIds Int[]
}

// ---------------------------
// 9. BuildPassive (Niveau du passif)
// ---------------------------
model BuildPassive {
  id        Int     @id @default(autoincrement())
  buildId   Int
  build     Build   @relation(fields: [buildId], references: [id])
  passiveId Int
  passive   Passive @relation(fields: [passiveId], references: [id])

  // Niveau choisi par l'utilisateur
  level    Int @default(1)
  maxLevel Int @default(20)
}

// ---------------------------
// 10. BuildStigma (Stigmas équipés)
// ---------------------------
model BuildStigma {
  id       Int    @id @default(autoincrement())
  buildId  Int
  build    Build  @relation(fields: [buildId], references: [id])
  stigmaId Int
  stigma   Stigma @relation(fields: [stigmaId], references: [id])

  level    Int @default(1)
  maxLevel Int @default(20)

  // Coût du stigma pour ce build (peut différer du baseCost)
  stigmaCost Int @default(10)
}
