generator client {
  provider               = "prisma-client"
  output                 = "../src/generated/prisma"
  generatedFileExtension = "ts"
  importFileExtension    = "ts"
  moduleFormat           = "esm"
}

datasource db {
  provider = "postgresql"
}

/// Utilisateur de l'application
/// Stocke les informations de profil et gère les relations avec les builds
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  builds        Build[]
  likes         Like[]
  sessions      Session[]
}

/// Compte OAuth lié à un utilisateur (Discord, Google, etc.)
/// Stocke les tokens d'accès et les informations du fournisseur OAuth
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

/// Session utilisateur active
/// Gère l'authentification persistante via cookies
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

/// Token de vérification pour l'email
/// Utilisé pour valider les adresses email lors de l'inscription
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

/// Classe de personnage jouable
/// Chaque classe possède des compétences uniques, des passifs et peut équiper certains stigmas
model Class {
  id           Int       @id @default(autoincrement())
  name         String    @unique
  description  String?
  iconUrl      String?
  bannerUrl    String?
  characterUrl String?
  abilities    Ability[]
  builds       Build[]
  passives     Passive[]
  stigmas      Stigma[]  @relation("ClassToStigma")
  tags         Tag[]     @relation("ClassToTag")
}

/// Tag/Catégorie pour classifier les classes
/// Permet de regrouper les classes par archétype (DPS, Tank, Healer, Support, etc.)
model Tag {
  id      Int     @id @default(autoincrement())
  name    String  @unique
  classes Class[] @relation("ClassToTag")
}

/// Tag de sort pour classifier les compétences
/// Permet de regrouper les compétences par type (Offensive, Défensive, Soin, etc.)
model SpellTag {
  id        Int       @id @default(autoincrement())
  name      String    @unique
  abilities Ability[] @relation("AbilityToSpellTag")
  passives  Passive[] @relation("PassiveToSpellTag")
  stigmas   Stigma[]  @relation("SpellTagToStigma")
}

/// Compétence active (Ability)
/// Représente une compétence de base d'une classe, améliorable jusqu'au niveau 10
/// Chaque compétence a des statistiques qui évoluent avec le niveau
model Ability {
  id                         Int               @id @default(autoincrement())
  name                       String
  description                String?
  damageMin                  Int?
  damageMax                  Int?
  castingDuration            String?           @default("Instant Cast")
  cooldown                   String?           @default("Instant Cast")
  maxLevel                   Int               @default(10)
  classId                    Int
  iconUrl                    String?
  area                       Int?              @default(4)
  baseCost                   Int               @default(1)
  baseCostModifier           Int               @default(2)
  damageMaxModifier          Int?
  damageMinModifier          Int?
  manaCost                   Int?
  manaRegen                  Int?
  range                      Int?              @default(20)
  staggerDamage              Int?
  target                     String?           @default("Single Target")
  damageMaxModifiers         Json?
  damageMinModifiers         Json?
  condition                  String[]          @default([])
  attack                     Int?
  attackModifier             Int?
  criticalHitResist          Int?
  criticalHitResistModifier  Int?
  damageBoost                Int?
  damageBoostModifier        Int?
  damageBoostModifiers       Json?
  damageTolerance            Int?
  damageToleranceModifier    Int?
  damageToleranceModifiers   Json?
  defense                    Int?
  defenseModifier            Int?
  healBoost                  Int?
  healBoostModifier          Int?
  healBoostModifiers         Int?
  healMax                    Int?
  healMaxModifier            Int?
  healMaxModifiers           Json?
  healMin                    Int?
  healMinModifier            Int?
  healMinModifiers           Json?
  impactTypeResist           Int?
  impactTypeResistModifier   Int?
  incomingHeal               Int?
  incomingHealModifier       Int?
  incomingHealModifiers      Int?
  maxHP                      Int?
  maxHPModifier              Int?
  maxHPModifiers             Json?
  maxMP                      Int?
  maxMPModifier              Int?
  maxMPModifiers             Json?
  minHP                      Int?
  minHPModifier              Int?
  minHPModifiers             Json?
  minMP                      Int?
  minMPModifier              Int?
  minMPModifiers             Json?
  statusEffectResist         Int?
  statusEffectResistModifier Int?
  blockDamage                Int?
  blockDamageModifier        Int?
  blockDamageModifiers       Json?
  damagePerSecond            Int?
  damagePerSecondModifier    Int?
  damagePerSecondModifiers   Json?
  chargeLevels               String?
  effectCondition            String?
  class                      Class             @relation(fields: [classId], references: [id])
  buildAbilities             BuildAbility[]
  chainSkills                ChainSkill[]      @relation("AbilityChainSkills")
  parentAbilities            ChainSkill[]      @relation("AbilityParentSkills")
  specialtyChoices           SpecialtyChoice[]
  spellTag                   SpellTag[]        @relation("AbilityToSpellTag")
}

/// Relation de Chain Skill entre deux Abilities
/// Définit qu'une compétence peut être enchaînée après une autre
/// avec des conditions spécifiques (ex: après un "Nontarget Skill" en mouvement)
model ChainSkill {
  id              Int      @id @default(autoincrement())
  parentAbilityId Int
  chainAbilityId  Int
  condition       String[] @default([])
  chainAbility    Ability  @relation("AbilityChainSkills", fields: [chainAbilityId], references: [id], onDelete: Cascade)
  parentAbility   Ability  @relation("AbilityParentSkills", fields: [parentAbilityId], references: [id], onDelete: Cascade)

  @@unique([parentAbilityId, chainAbilityId])
  @@index([parentAbilityId])
}

/// Relation de Chain Skill entre deux Stigmas
/// Même principe que ChainSkill mais pour les stigmas
model ChainSkillStigma {
  id             Int      @id @default(autoincrement())
  parentStigmaId Int
  chainStigmaId  Int
  condition      String[] @default([])
  chainStigma    Stigma   @relation("StigmaChainSkills", fields: [chainStigmaId], references: [id], onDelete: Cascade)
  parentStigma   Stigma   @relation("StigmaParentSkills", fields: [parentStigmaId], references: [id], onDelete: Cascade)

  @@unique([parentStigmaId, chainStigmaId])
  @@index([parentStigmaId])
}

/// Choix de spécialité pour une compétence
/// Permet de personnaliser une compétence à certains niveaux (ex: niveau 8, 12, 16)
/// Chaque choix modifie le comportement ou les statistiques de la compétence
model SpecialtyChoice {
  id          Int      @id @default(autoincrement())
  description String
  unlockLevel Int
  abilityId   Int?
  stigmaId    Int?
  ability     Ability? @relation(fields: [abilityId], references: [id])
  stigma      Stigma?  @relation(fields: [stigmaId], references: [id])
}

/// Compétence passive
/// Améliore les statistiques de base du personnage de manière permanente
/// Structure similaire à Ability mais sans coût de mana ni temps de recharge
model Passive {
  id                         Int            @id @default(autoincrement())
  name                       String
  description                String?
  maxLevel                   Int            @default(10)
  classId                    Int
  iconUrl                    String?
  area                       Int?           @default(4)
  attack                     Int?
  attackModifier             Int?
  baseCost                   Int            @default(1)
  baseCostModifier           Int            @default(2)
  castingDuration            String?        @default("Instant Cast")
  cooldown                   String?        @default("Instant Cast")
  criticalHitResist          Int?
  criticalHitResistModifier  Int?
  damageBoost                Int?
  damageMax                  Int?
  damageMaxModifier          Int?
  damageMin                  Int?
  damageMinModifier          Int?
  damageTolerance            Int?
  defense                    Int?
  defenseModifier            Int?
  healBoost                  Int?
  healBoostModifier          Int?
  healMax                    Int?
  healMaxModifier            Int?
  healMin                    Int?
  healMinModifier            Int?
  impactTypeResist           Int?
  impactTypeResistModifier   Int?
  incomingHeal               Int?
  incomingHealModifier       Int?
  manaCost                   Int?
  manaRegen                  Int?
  maxHP                      Int?
  maxHPModifier              Int?
  maxMP                      Int?
  maxMPModifier              Int?
  range                      Int?           @default(20)
  staggerDamage              Int?
  statusEffectResist         Int?
  statusEffectResistModifier Int?
  target                     String?        @default("Single Target")
  damageMaxModifiers         Json?
  damageMinModifiers         Json?
  healBoostModifiers         Int?
  healMaxModifiers           Json?
  healMinModifiers           Json?
  incomingHealModifiers      Int?
  maxHPModifiers             Json?
  maxMPModifiers             Json?
  damageBoostModifier        Int?
  damageBoostModifiers       Json?
  damageToleranceModifier    Int?
  damageToleranceModifiers   Json?
  minHP                      Int?
  minHPModifier              Int?
  minHPModifiers             Json?
  minMP                      Int?
  minMPModifier              Int?
  minMPModifiers             Json?
  blockDamage                Int?
  blockDamageModifier        Int?
  blockDamageModifiers       Json?
  damagePerSecond            Int?
  damagePerSecondModifier    Int?
  damagePerSecondModifiers   Json?
  chargeLevels               String?
  effectCondition            String?
  buildPassives              BuildPassive[]
  class                      Class          @relation(fields: [classId], references: [id])
  spellTag                   SpellTag[]     @relation("PassiveToSpellTag")
}

/// Stigma (compétence avancée équipable)
/// Compétence spéciale équipable par certaines classes, améliorable jusqu'au niveau 20
/// Coûte des Stigma Points (STP) pour être équipé dans un build
model Stigma {
  id                         Int                @id @default(autoincrement())
  name                       String
  description                String?
  baseCost                   Int                @default(1)
  iconUrl                    String?
  maxLevel                   Int                @default(20)
  area                       Int?               @default(4)
  baseCostModifier           Int                @default(2)
  castingDuration            String?            @default("Instant Cast")
  cooldown                   String?            @default("Instant Cast")
  damageMax                  Int?
  damageMaxModifier          Int?
  damageMin                  Int?
  damageMinModifier          Int?
  manaCost                   Int?
  manaRegen                  Int?
  range                      Int?               @default(20)
  staggerDamage              Int?
  target                     String?            @default("Single Target")
  damageMaxModifiers         Json?
  damageMinModifiers         Json?
  condition                  String[]           @default([])
  attack                     Int?
  attackModifier             Int?
  criticalHitResist          Int?
  criticalHitResistModifier  Int?
  damageBoost                Int?
  damageBoostModifier        Int?
  damageBoostModifiers       Json?
  damageTolerance            Int?
  damageToleranceModifier    Int?
  damageToleranceModifiers   Json?
  defense                    Int?
  defenseModifier            Int?
  healBoost                  Int?
  healBoostModifier          Int?
  healBoostModifiers         Int?
  healMax                    Int?
  healMaxModifier            Int?
  healMaxModifiers           Json?
  healMin                    Int?
  healMinModifier            Int?
  healMinModifiers           Json?
  impactTypeResist           Int?
  impactTypeResistModifier   Int?
  incomingHeal               Int?
  incomingHealModifier       Int?
  incomingHealModifiers      Int?
  maxHP                      Int?
  maxHPModifier              Int?
  maxHPModifiers             Json?
  maxMP                      Int?
  maxMPModifier              Int?
  maxMPModifiers             Json?
  minHP                      Int?
  minHPModifier              Int?
  minHPModifiers             Json?
  minMP                      Int?
  minMPModifier              Int?
  minMPModifiers             Json?
  statusEffectResist         Int?
  statusEffectResistModifier Int?
  blockDamage                Int?
  blockDamageModifier        Int?
  blockDamageModifiers       Json?
  damagePerSecond            Int?
  damagePerSecondModifier    Int?
  damagePerSecondModifiers   Json?
  chargeLevels               String
  effectCondition            String?
  buildStigmas               BuildStigma[]
  chainSkills                ChainSkillStigma[] @relation("StigmaChainSkills")
  parentStigmas              ChainSkillStigma[] @relation("StigmaParentSkills")
  specialtyChoices           SpecialtyChoice[]
  classes                    Class[]            @relation("ClassToStigma")
  spellTag                   SpellTag[]         @relation("SpellTagToStigma")
}

/// Build personnalisé créé par un utilisateur
/// Représente une configuration complète de compétences pour une classe
/// Peut être un "starter build" (sans propriétaire) ou un build utilisateur
model Build {
  id        Int            @id @default(autoincrement())
  name      String
  classId   Int
  baseSP    Int            @default(231)
  extraSP   Int            @default(0)
  baseSTP   Int            @default(40)
  extraSTP  Int            @default(0)
  shortcuts Json?
  userId    String?
  class     Class          @relation(fields: [classId], references: [id])
  user      User?          @relation(fields: [userId], references: [id], onDelete: Cascade)
  abilities BuildAbility[]
  passives  BuildPassive[]
  stigmas   BuildStigma[]
  likes     Like[]
  daevanion BuildDaevanion?
}

/// Like d'un build par un utilisateur
/// Permet aux utilisateurs de marquer leur appréciation pour un build
/// Un utilisateur ne peut liker un build qu'une seule fois
model Like {
  id        Int      @id @default(autoincrement())
  buildId   Int
  userId    String
  createdAt DateTime @default(now())
  build     Build    @relation(fields: [buildId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([buildId, userId])
  @@index([buildId])
  @@index([userId])
}

/// Configuration d'une compétence active dans un build
/// Stocke le niveau choisi, les spécialités activées et les chain skills sélectionnés
model BuildAbility {
  id                       Int     @id @default(autoincrement())
  buildId                  Int
  abilityId                Int
  level                    Int     @default(1)
  activeSpecialtyChoiceIds Int[]
  maxLevel                 Int     @default(20)
  selectedChainSkillIds    Int[]   @default([])
  ability                  Ability @relation(fields: [abilityId], references: [id])
  build                    Build   @relation(fields: [buildId], references: [id])
}

/// Configuration d'un passif dans un build
/// Stocke uniquement le niveau choisi (les passifs n'ont pas de spécialités ni chain skills)
model BuildPassive {
  id        Int     @id @default(autoincrement())
  buildId   Int
  passiveId Int
  level     Int     @default(1)
  maxLevel  Int     @default(20)
  build     Build   @relation(fields: [buildId], references: [id])
  passive   Passive @relation(fields: [passiveId], references: [id])
}

/// Configuration d'un stigma équipé dans un build
/// Stocke le niveau, le coût en STP, les spécialités activées et les chain skills sélectionnés
/// Un build peut équiper un maximum de 4 stigmas actifs (niveau >= 1)
model BuildStigma {
  id                       Int    @id @default(autoincrement())
  buildId                  Int
  stigmaId                 Int
  stigmaCost               Int    @default(10)
  level                    Int    @default(1)
  maxLevel                 Int    @default(20)
  activeSpecialtyChoiceIds Int[]
  selectedChainSkillIds    Int[]  @default([])
  build                    Build  @relation(fields: [buildId], references: [id])
  stigma                   Stigma @relation(fields: [stigmaId], references: [id])
}

/// Rune Daevanion
/// Stocke les informations d'une rune Daevanion (position, rareté, stats, prérequis)
model DaevanionRune {
  id            Int                @id @default(autoincrement())
  slotId        Int
  path          String             // "nezekan", "zikel", etc.
  rarity        String             // "common", "rare", "legend", "unique"
  name          String
  description   String?
  positionX     Int
  positionY     Int
  prerequisites Int[]              @default([]) // Array de slotIds requis
  // Stats stockées en JSON pour flexibilité
  stats         Json?
  
  @@unique([path, slotId])
  @@index([path])
}

/// Configuration Daevanion pour un build
/// Stocke les runes activées pour chaque chemin Daevanion
model BuildDaevanion {
  id        Int   @id @default(autoincrement())
  buildId   Int   @unique
  nezekan   Int[] @default([]) // Array de slotIds activés
  zikel     Int[] @default([])
  vaizel    Int[] @default([])
  triniel   Int[] @default([])
  ariel     Int[] @default([])
  azphel    Int[] @default([])
  build     Build @relation(fields: [buildId], references: [id], onDelete: Cascade)
}
